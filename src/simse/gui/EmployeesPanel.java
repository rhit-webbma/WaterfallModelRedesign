/* File generated by: simse.codegenerator.guigenerator.ActionPanelGenerator */
package simse.gui;

import java.util.ArrayList;
//import java.text.*;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Vector;

import animations.CreatablePath;
import animations.DisplayableCharacter;
import animations.PathData;
import animations.SimSECharacter;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.control.ContextMenu;
import javafx.scene.control.Label;
import javafx.scene.control.MenuItem;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.TitledPane;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseButton;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.Border;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.BorderStroke;
import javafx.scene.layout.BorderStrokeStyle;
import javafx.scene.layout.BorderWidths;
import javafx.scene.layout.CornerRadii;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Pane;
import javafx.scene.layout.VBox;
import javafx.scene.paint.Color;
import javafx.scene.shape.Path;
import javafx.scene.text.Font;
import javafx.scene.text.TextAlignment;
import simse.adts.actions.Action;
import simse.adts.actions.BreakAction;
import simse.adts.actions.CorrectCodeAction;
import simse.adts.actions.CorrectDesignAction;
import simse.adts.actions.CorrectRequirementsAction;
import simse.adts.actions.CorrectSystemTestPlanAction;
import simse.adts.actions.CreateCodeAction;
import simse.adts.actions.CreateDesignAction;
import simse.adts.actions.CreateRequirementsAction;
import simse.adts.actions.CreateSystemTestPlanAction;
import simse.adts.actions.GetSickAction;
import simse.adts.actions.InspectCodeAction;
import simse.adts.actions.IntegrateCodeAction;
import simse.adts.actions.ReviewDesignAction;
import simse.adts.actions.ReviewRequirementsAction;
import simse.adts.actions.ReviewSystemTestPlanAction;
import simse.adts.actions.SystemTestAction;
import simse.adts.objects.Employee;
import simse.adts.objects.SoftwareEngineer;
import simse.gui.util.JavaFXHelpers;
import simse.logic.Logic;
import simse.state.State;

public class EmployeesPanel extends Pane implements EventHandler<MouseEvent>, SimSEPanel {
	private State state;
	private Logic logic;
	private SimSEGUI mainGUIFrame;

	private ContextMenu popup;

	private Employee selectedEmp;

	private ScrollPane actionPane;
	private Hashtable<Employee, VBox> empsToEmpPanels;
	private Hashtable<Employee, HBox> empsToPicPanels;
	// private Hashtable empsToActPanels;
	private Hashtable<Employee, Label> empsToPicLabels;
	private Hashtable<Employee, Label> empsToKeyLabels;
	
	ArrayList<DisplayableCharacter> characters;

	private VBox layout;

	private EventHandler<ActionEvent> menuItemEvent = new EventHandler<ActionEvent>() {
		public void handle(ActionEvent event) {
			Object source = event.getSource();
			if (source instanceof MenuItem) {
				popupMenuActions((MenuItem) source);
			}
		}
	};

	public EmployeesPanel(SimSEGUI gui, State s, Logic l) {
		state = s;
		logic = l;
		mainGUIFrame = gui;

		layout = new VBox();
		layout.setId("actionPanelVBox");

		actionPane = new ScrollPane();
		actionPane.setId("scrollPaneActionPanel");
		actionPane.setPrefSize(225, 425);
		actionPane.setId("ActionPanelMain");
//		actionPane.setStyle("-fx-background: rgb(102, 102, 102, 1);\n -fx-background-color: rgb(102, 102, 102, 1)");

		empsToEmpPanels = new Hashtable<Employee, VBox>();
		empsToPicPanels = new Hashtable<Employee, HBox>();
		// empsToActPanels = new Hashtable();
		empsToPicLabels = new Hashtable<Employee, Label>();
		empsToKeyLabels = new Hashtable<Employee, Label>();

//		BorderPane titlePanel = new BorderPane();
		
		
		VBox actionPanelLayout = new VBox();
	
	
//		Label titleLabel = new Label("Current Activities:");
//		Font f = titleLabel.getFont();
//		Font newFont = new Font(f.getName(), 15);
//		titleLabel.setFont(newFont);
//		titleLabel.setTextFill(Color.BLACK);
		
//		actionPanelLayout.getChildren().add(titleLabel);
//		actionPanelLayout.getChildren().add(actionPane);
//		actionPanelLayout.setId("ActionPanelLayout");
		
		TitledPane titlePanel = new TitledPane("Employee Panel", actionPane);
		titlePanel.setBorder(Border.EMPTY);
		titlePanel.setId("ActionTitlePanel");
		titlePanel.setBackground(JavaFXHelpers.createBackgroundColor(Color.rgb(102, 102, 102, 1)));
		
		
//		titlePanel.setLeft(titleLabel);
		selectedEmp = null;
		popup = new ContextMenu();

//		layout.getChildren().add(titlePanel);
//		layout.getChildren().add(actionPane);
		layout.getChildren().add(titlePanel);
		
		Vector<Employee> allEmps = state.getEmployeeStateRepository().getAll();
		characters = new ArrayList<DisplayableCharacter>();
		
		for (int i = 0; i < allEmps.size(); i++) {
			DisplayableCharacter char1 = new SimSECharacter(i, 50, 75);
			characters.add(char1);
		}
		update();
		this.getChildren().add(layout);		
	}

	public void createPopupMenu(Node node, double x, double y) {
		popup.getItems().clear();

		if (mainGUIFrame.getEngine().isRunning()) {
			return;
		}

		if (selectedEmp != null) {
			Vector<String> menuItems = selectedEmp.getMenu();
			for (int i = 0; i < menuItems.size(); i++) {
				String item = menuItems.elementAt(i);
				MenuItem tempItem = new MenuItem(item);
				tempItem.setOnAction(menuItemEvent);
				popup.getItems().addAll(tempItem);
			}
			if (menuItems.size() >= 1) {
				popup.show(node, x, y);
			}
		}
	}

	public void update() {
		actionPane.setContent(null);

		empsToEmpPanels.clear();
		
		Label titleLabel = new Label("Current Activities:");
		Font f = titleLabel.getFont();
		Font newFont = new Font(f.getName(), 15);
		titleLabel.setFont(newFont);
		titleLabel.setTextFill(Color.BLACK);
	
		VBox employees = new VBox();
		employees.getChildren().add(titleLabel);
		employees.setSpacing(2);
		Vector<Employee> allEmps = state.getEmployeeStateRepository().getAll();
		for (int i = 0; i < allEmps.size(); i++) {
			Employee emp = allEmps.elementAt(i);
			if (empsToEmpPanels.get(emp) == null) {
				VBox tempPanel = new VBox();
				tempPanel.addEventHandler(MouseEvent.ANY, this);
				empsToEmpPanels.put(emp, tempPanel);
			}
			if (empsToPicPanels.get(emp) == null) {
				HBox tempPanel = new HBox();
				tempPanel.addEventHandler(MouseEvent.ANY, this);
				empsToPicPanels.put(emp, tempPanel);
			}
			VBox empPanel = empsToEmpPanels.get(emp);
			empPanel.getChildren().removeAll();
			HBox picPanel = (HBox) empsToPicPanels.get(emp);
			picPanel.setSpacing(5);
			picPanel.setAlignment(Pos.BASELINE_LEFT);
			picPanel.getChildren().removeAll();

			GridPane gpLayout = new GridPane();
			gpLayout.getChildren().add(empPanel);

//			empPanel.setBackground(JavaFXHelpers.createBackgroundColor(Color.rgb(102, 102, 102, 1)));
			empPanel.setId("ActionPanelEmployee");
			picPanel.setId("ActionPanelEmployeeBox");
			picPanel.prefWidthProperty().bind(actionPane.widthProperty());
			empPanel.prefWidthProperty().bind(actionPane.widthProperty());
//			empPanel.setId("ActionPanelEmployee");
//			picPanel.setBackground(JavaFXHelpers.createBackgroundColor(Color.rgb(102, 102, 102, 1)));
			if (empsToPicLabels.get(emp) == null) {				
				ImageView ico = characters.get(i).getStaticImage();

				ico.setFitHeight(40);
				ico.setFitWidth(40);
				Label temp = new Label();
				temp.setGraphic(ico);
				temp.addEventHandler(MouseEvent.ANY, this);
				empsToPicLabels.put(emp, temp);
			}

			Label picLabel = empsToPicLabels.get(emp);
			picLabel.setAlignment(Pos.BASELINE_LEFT);
			picLabel.setId("EmployeePic");
			if(!picPanel.getChildren().contains(picLabel)) {
				picPanel.getChildren().add(picLabel);
			}
			if (emp instanceof SoftwareEngineer) {
				SoftwareEngineer e = (SoftwareEngineer) emp;
				if (empsToKeyLabels.get(e) == null) {
					Label temp = new Label("" + e.getName() + " - Software Engineer");
					temp.setTextFill(Color.BLACK);
					temp.setAlignment(Pos.BASELINE_LEFT);
					temp.setTextAlignment(TextAlignment.LEFT);
					empsToKeyLabels.put(e, temp);
				}
				Label keyLabel = empsToKeyLabels.get(e);
				keyLabel.setId("EmployeeName");
				if(!picPanel.getChildren().contains(keyLabel)) {
					picPanel.getChildren().add(keyLabel);
				}
			}
			picPanel.setBorder(Border.EMPTY);
			if(!empPanel.getChildren().contains(picPanel)) {
				empPanel.getChildren().add(picPanel);
			}
			VBox actsPanel = new VBox();

			actsPanel.setBackground(JavaFXHelpers.createBackgroundColor(Color.rgb(102, 102, 102, 1)));
			empPanel.setBorder(new Border(new BorderStroke(Color.rgb(102, 102, 102, 1), BorderStrokeStyle.SOLID, CornerRadii.EMPTY, BorderWidths.FULL)));
			Vector<Action> acts = state.getActionStateRepository().getAllActions(emp);
			for (int j = 0; j < acts.size(); j++) {
				Action tempAct = acts.elementAt(j);
				if (tempAct instanceof CreateRequirementsAction) {
					Label tempLabel = new Label("Creating requirements");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof ReviewRequirementsAction) {
					Label tempLabel = new Label("Reviewing requirements");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CorrectRequirementsAction) {
					Label tempLabel = new Label("Correcting requirements");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CreateDesignAction) {
					Label tempLabel = new Label("Creating design");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof ReviewDesignAction) {
					Label tempLabel = new Label("Reviewing design");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CorrectDesignAction) {
					Label tempLabel = new Label("Correcting design");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CreateCodeAction) {
					Label tempLabel = new Label("Creating code");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof InspectCodeAction) {
					Label tempLabel = new Label("Inspecting code");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CorrectCodeAction) {
					Label tempLabel = new Label("Correcting code");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof IntegrateCodeAction) {
					Label tempLabel = new Label("Integrating code");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof SystemTestAction) {
					Label tempLabel = new Label("Doing system test");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CreateSystemTestPlanAction) {
					Label tempLabel = new Label("Creating system test plan");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof ReviewSystemTestPlanAction) {
					Label tempLabel = new Label("Reviewing system test plan");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof CorrectSystemTestPlanAction) {
					Label tempLabel = new Label("Correcting system test plan");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof BreakAction) {
					Label tempLabel = new Label("On a break");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				} else if (tempAct instanceof GetSickAction) {
					Label tempLabel = new Label("Out sick");
					tempLabel.setFont(new Font(tempLabel.getFont().getName(), 10));
					tempLabel.setTextFill(Color.WHITE);
					actsPanel.getChildren().add(tempLabel);
				}
			}
			actsPanel.setPrefSize(150, (int) (actsPanel.getPrefHeight()));
			empPanel.getChildren().add(actsPanel);
			employees.getChildren().add(empPanel);
		}
		actionPane.setContent(employees);
	}	

	public void popupMenuActions(MenuItem source) {
		MenuItem item = (MenuItem) source;
		logic.getMenuInputManager().menuItemSelected(selectedEmp, item.getText(), mainGUIFrame);
		mainGUIFrame.getWorld().update();
	}

	private Employee getEmpFromPicLabel(Label label) {
		for (Enumeration<Employee> keys = empsToPicLabels.keys(); keys.hasMoreElements();) {
			Employee keyEmp = keys.nextElement();
			if (empsToPicLabels.get(keyEmp) == label) {
				return keyEmp;
			}
		}
		return null;
	}

	private Employee getEmpFromPanel(Pane panel) {
		for (Enumeration<Employee> keys = empsToEmpPanels.keys(); keys.hasMoreElements();) {
			Employee keyEmp = keys.nextElement();
			if (empsToEmpPanels.get(keyEmp) == panel) {
				return keyEmp;
			}
		}
		for (Enumeration<Employee> keys = empsToPicPanels.keys(); keys.hasMoreElements();) {
			Employee keyEmp = keys.nextElement();
			if (empsToPicPanels.get(keyEmp) == panel) {
				return keyEmp;
			}
		}
		return null;
	}

	@Override
	public void handle(MouseEvent event) {
		if (event.getEventType() == MouseEvent.MOUSE_RELEASED) {
			if (event.getSource() instanceof Label) {
				Label label = (Label) event.getSource();
				Employee emp = getEmpFromPicLabel(label);
				if (emp != null) {
					if (event.getButton().equals(MouseButton.PRIMARY)) // left button clicked
					{
						mainGUIFrame.getTabPanel().setGUIChanged();
						mainGUIFrame.getTabPanel().setObjectInFocus(emp);
						mainGUIFrame.getAttributePanel().setGUIChanged();
						mainGUIFrame.getAttributePanel().setObjectInFocus(emp, JavaFXHelpers.createImage(TabPanel.getImage(emp)));
					} else if (event.isPopupTrigger() && (state.getClock().isStopped() == false)) // right-click
					{
						selectedEmp = emp;
						createPopupMenu(label, event.getSceneX(), event.getSceneY());
					}
				}
			} else if (event.getSource() instanceof Pane) {
				Pane pane = (Pane) event.getSource();
				Employee emp = getEmpFromPanel(pane);
				if (emp != null) {
					if (event.isPrimaryButtonDown()) // left button clicked
					{
						mainGUIFrame.getTabPanel().setGUIChanged();
						mainGUIFrame.getTabPanel().setObjectInFocus(emp);
						mainGUIFrame.getAttributePanel().setGUIChanged();
						mainGUIFrame.getAttributePanel().setObjectInFocus(emp,JavaFXHelpers.createImage(TabPanel.getImage(emp)));
					} else if (event.isPopupTrigger() && (state.getClock().isStopped() == false)) // right-click
					{
						selectedEmp = emp;
						createPopupMenu(pane, event.getSceneX(), event.getSceneY());
					}
				}
			}
		}
	}

	@Override
	public Panels getPanelType() {
		return Panels.EMPLOYEES;
	}
}
