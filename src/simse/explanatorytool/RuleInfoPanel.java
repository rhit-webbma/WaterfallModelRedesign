/* File generated by: simse.codegenerator.explanatorytoolgenerator.RuleInfoPanelGenerator */
package simse.explanatorytool;

import javafx.event.EventHandler;
import javafx.geometry.Pos;
import javafx.scene.control.ListView;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.ScrollPane.ScrollBarPolicy;
import javafx.scene.control.SelectionMode;
import javafx.scene.control.TextArea;
import javafx.scene.control.TitledPane;
import javafx.scene.control.Tooltip;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.Pane;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import simse.adts.actions.Action;
import simse.util.RuleCategories;

public class RuleInfoPanel extends Pane implements EventHandler<MouseEvent> {
	private Action action; // action in focus

	private ListView<String> triggerRuleList;
	private ListView<String> destroyerRuleList;
	private ListView<String> intermediateRuleList;
	private TextArea descriptionArea; // for displaying a rule description

	public RuleInfoPanel(Stage owner, Action action) {
		this.action = action;

		// Create main panel:
		GridPane mainPane = new GridPane();
		mainPane.setPrefSize(900, 600);
		mainPane.setHgap(10);
		mainPane.setVgap(10);

		// Create rule pane and components:
		VBox tRulePane = new VBox();
		TitledPane trigRuleTitlePane = new TitledPane("Trigger Rules:", tRulePane);

		// rule lists:
		triggerRuleList = new ListView<String>();
		triggerRuleList.setFixedCellSize(24);
		triggerRuleList.getSelectionModel().setSelectionMode(SelectionMode.SINGLE);
		triggerRuleList.addEventHandler(MouseEvent.MOUSE_CLICKED, this);
		ScrollPane triggerRuleListPane = new ScrollPane(triggerRuleList);
		triggerRuleListPane.setMaxHeight(100);
		triggerRuleListPane.setVbarPolicy(ScrollBarPolicy.AS_NEEDED);
		triggerRuleListPane.setHbarPolicy(ScrollBarPolicy.NEVER);
		String trigToolTip = "Rules that execute at the beginning of the action";
		trigRuleTitlePane.setTooltip(new Tooltip(trigToolTip));
		triggerRuleList.setTooltip(new Tooltip(trigToolTip));
		tRulePane.getChildren().add(triggerRuleListPane);

		VBox dRulePane = new VBox();
		TitledPane destRuleTitlePane = new TitledPane("Destroyer Rules: ", dRulePane);
		destroyerRuleList = new ListView<String>();
		destroyerRuleList.setFixedCellSize(24);
		destroyerRuleList.getSelectionModel().setSelectionMode(SelectionMode.SINGLE);
		destroyerRuleList.addEventHandler(MouseEvent.MOUSE_CLICKED, this);
		ScrollPane destroyerRuleListPane = new ScrollPane(destroyerRuleList);
		destroyerRuleListPane.setMaxHeight(100);
		destroyerRuleListPane.setVbarPolicy(ScrollBarPolicy.AS_NEEDED);
		destroyerRuleListPane.setHbarPolicy(ScrollBarPolicy.NEVER);
		String destToolTip = "Rules that execute at the end of the action";
		destRuleTitlePane.setTooltip(new Tooltip(destToolTip));
		destroyerRuleList.setTooltip(new Tooltip(destToolTip));
		dRulePane.getChildren().add(destroyerRuleListPane);

		VBox iRulePane = new VBox();
		TitledPane intRuleTitlePane = new TitledPane("Intermediate Rules:", iRulePane);
		intermediateRuleList = new ListView<String>();
		intermediateRuleList.setFixedCellSize(24);
		intermediateRuleList.getSelectionModel().setSelectionMode(SelectionMode.SINGLE);
		intermediateRuleList.addEventHandler(MouseEvent.MOUSE_CLICKED, this);
		ScrollPane intermediateRuleListPane = new ScrollPane(intermediateRuleList);
		intermediateRuleListPane.setMaxHeight(100);
		intermediateRuleListPane.setVbarPolicy(ScrollBarPolicy.AS_NEEDED);
		intermediateRuleListPane.setHbarPolicy(ScrollBarPolicy.NEVER);
		String intToolTip = "Rules that execute every clock tick during the life of the action";
		intRuleTitlePane.setTooltip(new Tooltip(intToolTip));
		intermediateRuleList.setTooltip(new Tooltip(intToolTip));
		iRulePane.getChildren().add(intermediateRuleListPane);

		VBox rulePane = new VBox();
		rulePane.getChildren().add(trigRuleTitlePane);
		rulePane.getChildren().add(destRuleTitlePane);
		rulePane.getChildren().add(intRuleTitlePane);
		initializeRuleLists();

		// description pane:
		VBox descriptionPane = new VBox();
		TitledPane descriptionTitlePane = new TitledPane("Description:", descriptionPane);

		// description text area:
		descriptionArea = new TextArea();
		descriptionArea.setPrefColumnCount(29);
		descriptionArea.setPrefRowCount(25);
		descriptionArea.setWrapText(true);
		descriptionArea.setEditable(false);
		ScrollPane descriptionScrollPane = new ScrollPane(descriptionArea);
		descriptionScrollPane.setHbarPolicy(ScrollBarPolicy.NEVER);
		descriptionScrollPane.setVbarPolicy(ScrollBarPolicy.AS_NEEDED);
		descriptionPane.getChildren().add(descriptionScrollPane);
	
		mainPane.add(rulePane, 0, 0);
		mainPane.add(descriptionTitlePane, 1, 0, 1, 3);
		mainPane.setAlignment(Pos.CENTER);
		this.getChildren().add(mainPane);
	}

	private void initializeRuleLists() {
		String actionName = action.getActionName();
		
		String[] intList = RuleCategories.getIntRulesForAction(actionName);
		String[] trigList = RuleCategories.getTrigRulesForAction(actionName);
		String[] destList = RuleCategories.getDestRulesForAction(actionName);
		
		intermediateRuleList.getItems().setAll(intList);
		triggerRuleList.getItems().setAll(trigList);
		destroyerRuleList.getItems().setAll(destList);
	}

	// refreshes the description area with the selected rule description
	private void refreshDescriptionArea() {
		String name = null;
		if (!triggerRuleList.getSelectionModel().isEmpty()) {
			name = (String) triggerRuleList.getSelectionModel().getSelectedItem();
		} else if (!destroyerRuleList.getSelectionModel().isEmpty()) {
			name = (String) destroyerRuleList.getSelectionModel().getSelectedItem();
		} else if (!intermediateRuleList.getSelectionModel().isEmpty()) {
			name = (String) intermediateRuleList.getSelectionModel().getSelectedItem();
		}
		if (name != null) {
			String text = RuleCategories.getRuleMapping(name);
			descriptionArea.setText(text);
			descriptionArea.positionCaret(0);
		}
	}

	@Override
	public void handle(MouseEvent event) {
		if ((event.getSource() == triggerRuleList && !triggerRuleList.getSelectionModel().isEmpty())) {
			destroyerRuleList.getSelectionModel().clearSelection();
			intermediateRuleList.getSelectionModel().clearSelection();
			refreshDescriptionArea();
		} else if (event.getSource() == destroyerRuleList && !destroyerRuleList.getSelectionModel().isEmpty()) {
			triggerRuleList.getSelectionModel().clearSelection();
			intermediateRuleList.getSelectionModel().clearSelection();
			refreshDescriptionArea();
		} else if (event.getSource() == intermediateRuleList && !intermediateRuleList.getSelectionModel().isEmpty()) {
			triggerRuleList.getSelectionModel().clearSelection();
			destroyerRuleList.getSelectionModel().clearSelection();
			refreshDescriptionArea();
		}
	}
}